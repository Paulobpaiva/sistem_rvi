{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #map {
        height: 400px;
        width: 100%;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .route-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .route-info h6 {
        color: #495057;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2 class="text-center mb-0">{{ titulo }}</h2>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <!-- Informa√ß√µes do Solicitante -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="border-bottom pb-2">Informa√ß√µes do Solicitante</h4>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.nome_solicitante.id_for_label }}" class="form-label">
                                    <strong>Nome do Solicitante:</strong>
                                </label>
                                {{ form.nome_solicitante }}
                                {% if form.nome_solicitante.errors %}
                                    <div class="text-danger">{{ form.nome_solicitante.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.departamento.id_for_label }}" class="form-label">
                                    <strong>Departamento:</strong>
                                </label>
                                {{ form.departamento }}
                                {% if form.departamento.errors %}
                                    <div class="text-danger">{{ form.departamento.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="{{ form.ramal.id_for_label }}" class="form-label">
                                    <strong>Ramal:</strong>
                                </label>
                                {{ form.ramal }}
                                {% if form.ramal.errors %}
                                    <div class="text-danger">{{ form.ramal.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.chefia_imediata.id_for_label }}" class="form-label">
                                    <strong>Chefia imediata:</strong>
                                </label>
                                {{ form.chefia_imediata }}
                                {% if form.chefia_imediata.errors %}
                                    <div class="text-danger">{{ form.chefia_imediata.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Informa√ß√µes da Solicita√ß√£o -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="border-bottom pb-2">Informa√ß√µes da Solicita√ß√£o</h4>
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.finalidade.id_for_label }}" class="form-label">
                                    <strong>Finalidade da solicita√ß√£o:</strong>
                                </label>
                                {{ form.finalidade }}
                                {% if form.finalidade.errors %}
                                    <div class="text-danger">{{ form.finalidade.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.tipo_veiculo.id_for_label }}" class="form-label">
                                    <strong>Tipo de Ve√≠culo:</strong>
                                </label>
                                {{ form.tipo_veiculo }}
                                {% if form.tipo_veiculo.errors %}
                                    <div class="text-danger">{{ form.tipo_veiculo.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Destino e Mapa -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="border-bottom pb-2">Destino e Rota</h4>
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.cep.id_for_label }}" class="form-label">
                                    <strong>CEP:</strong>
                                </label>
                                {{ form.cep }}
                                {% if form.cep.errors %}
                                    <div class="text-danger">{{ form.cep.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Digite o CEP para carregar o endere√ßo automaticamente (opcional)
                                </small>
                            </div>
                            <div class="col-md-8">
                                <label for="{{ form.destino_endereco.id_for_label }}" class="form-label">
                                    <strong>Destino/Endere√ßo:</strong>
                                </label>
                                {{ form.destino_endereco }}
                                {% if form.destino_endereco.errors %}
                                    <div class="text-danger">{{ form.destino_endereco.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Digite o endere√ßo completo ou use o CEP para autopreenchimento
                                </small>
                            </div>
                            <div class="col-12 mt-3">
                                <div id="map"></div>
                                <div class="route-info" id="route-info" style="display: none;">
                                    <h6><i class="fas fa-route"></i> Informa√ß√µes da Rota</h6>
                                    <div id="route-details"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="{{ form.descricao_servico.id_for_label }}" class="form-label">
                                    <strong>Descri√ß√£o do servi√ßo:</strong>
                                </label>
                                {{ form.descricao_servico }}
                                {% if form.descricao_servico.errors %}
                                    <div class="text-danger">{{ form.descricao_servico.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Data e Hor√°rios -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h4 class="border-bottom pb-2">Data e Hor√°rios</h4>
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.data_realizacao.id_for_label }}" class="form-label">
                                    <strong>Data para realiza√ß√£o do servi√ßo:</strong>
                                </label>
                                {{ form.data_realizacao }}
                                {% if form.data_realizacao.errors %}
                                    <div class="text-danger">{{ form.data_realizacao.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.hora_saida.id_for_label }}" class="form-label">
                                    <strong>Hora sa√≠da:</strong>
                                </label>
                                {{ form.hora_saida }}
                                {% if form.hora_saida.errors %}
                                    <div class="text-danger">{{ form.hora_saida.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.hora_retorno.id_for_label }}" class="form-label">
                                    <strong>Hora retorno (Previs√£o):</strong>
                                </label>
                                {{ form.hora_retorno }}
                                {% if form.hora_retorno.errors %}
                                    <div class="text-danger">{{ form.hora_retorno.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                    <strong>Observa√ß√µes:</strong>
                                </label>
                                {{ form.observacoes }}
                                {% if form.observacoes.errors %}
                                    <div class="text-danger">{{ form.observacoes.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Mensagens de erro do formul√°rio -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Bot√µes -->
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'solicitacoes:list' %}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Aguardar o DOM carregar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== SISTEMA DE SOLICITA√á√ÉO CARREGADO ===');
        
        // Verificar se os elementos existem
        const cepField = document.getElementById('cep');
        const enderecoField = document.getElementById('destino_endereco');
        const horaSaidaField = document.getElementById('hora_saida');
        const horaRetornoField = document.getElementById('hora_retorno');
        const mapElement = document.getElementById('map');
        
        console.log('Elementos encontrados:', {
            cep: !!cepField,
            endereco: !!enderecoField,
            horaSaida: !!horaSaidaField,
            horaRetorno: !!horaRetornoField,
            map: !!mapElement
        });
        
        if (!mapElement) {
            console.error('Elemento do mapa n√£o encontrado!');
            return;
        }
        
        // Endere√ßo da empresa (Instituto Aggeu Magalh√£es)
        const empresaAddress = "Instituto Aggeu Magalh√£es - Funda√ß√£o Oswaldo Cruz, Universidade Federal de Pernambuco - Campus da, Av. Prof. Moraes Rego, s/n - Cidade Universit√°ria, Recife - PE, 50740-465";
        
        // Coordenadas aproximadas da empresa (Recife, PE)
        const empresaCoords = [-8.0476, -34.8770];
        
        console.log('Inicializando mapa...');
        
        // Inicializar mapa
        const map = L.map('map').setView(empresaCoords, 13);
        
        // Adicionar camada de tiles do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Marcador da empresa
        const empresaMarker = L.marker(empresaCoords).addTo(map);
        empresaMarker.bindPopup('<strong>Instituto Aggeu Magalh√£es</strong><br>Ponto de partida').openPopup();
        
        let destinoMarker = null;
        let routeLayer = null;
        
        console.log('Mapa inicializado com sucesso!');
        
        // Fun√ß√£o para buscar endere√ßo por CEP
        async function buscarCep(cep) {
            try {
                console.log('üîç Buscando CEP:', cep);
                // Remover caracteres n√£o num√©ricos (incluindo h√≠fen)
                cep = cep.replace(/\D/g, '');
                
                console.log('üîç CEP limpo:', cep);
                
                if (cep.length !== 8) {
                    console.log('‚ùå CEP inv√°lido:', cep);
                    return null;
                }
                
                console.log('üì° Fazendo requisi√ß√£o para ViaCEP...');
                const url = `https://viacep.com.br/ws/${cep}/json/`;
                console.log('üì° URL da requisi√ß√£o:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                console.log('üì® Resposta ViaCEP:', data);
                
                // Verificar se h√° erro na resposta
                if (data.erro) {
                    console.log('‚ùå CEP n√£o encontrado na API');
                    return null;
                }
                
                // Verificar se tem logradouro
                if (data.logradouro && data.logradouro.trim() !== '') {
                    const endereco = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
                    console.log('‚úÖ Endere√ßo encontrado:', endereco);
                    return endereco;
                } else {
                    console.log('‚ùå CEP encontrado mas sem logradouro:', data);
                    return null;
                }
            } catch (error) {
                console.error('üí• Erro ao buscar CEP:', error);
                return null;
            }
        }
        
        // Fun√ß√£o para geocodificar endere√ßo
        async function geocodeAddress(address) {
            try {
                console.log('üåç Geocodificando endere√ßo:', address);
                
                // Limpar e formatar o endere√ßo
                let cleanAddress = address.trim();
                
                // Adicionar contexto brasileiro se n√£o estiver presente
                if (!cleanAddress.toLowerCase().includes('brasil') && !cleanAddress.toLowerCase().includes('br')) {
                    cleanAddress += ', Brasil';
                }
                
                console.log('üîç Endere√ßo formatado:', cleanAddress);
                
                // Primeiro, verificar se √© uma cidade conhecida e usar coordenadas aproximadas
                const cityCoords = {
                    'S√£o Louren√ßo da Mata': [-8.0024, -35.0183],
                    'Recife': [-8.0476, -34.8770],
                    'Olinda': [-8.0089, -34.8554],
                    'Jaboat√£o dos Guararapes': [-8.1128, -35.0147],
                    'Paulista': [-7.9408, -34.8731],
                    'Camaragibe': [-8.0231, -34.9781],
                    'Abreu e Lima': [-7.9111, -34.9028],
                    'Igarassu': [-7.8341, -34.9064],
                    'Itapissuma': [-7.7764, -34.8922],
                    'Goiana': [-7.5606, -35.0025]
                };
                
                // Procurar por coordenadas da cidade no endere√ßo
                for (const [city, coords] of Object.entries(cityCoords)) {
                    if (cleanAddress.toLowerCase().includes(city.toLowerCase())) {
                        console.log(`‚úÖ Usando coordenadas aproximadas de ${city}:`, coords);
                        return coords;
                    }
                }
                
                // Se n√£o encontrou cidade espec√≠fica, tentar com Nominatim
                console.log('üîÑ Tentando com Nominatim...');
                
                // Tentar diferentes varia√ß√µes do endere√ßo
                const searchVariations = [
                    cleanAddress,
                    cleanAddress.replace(/,\s*/, ', '), // Garantir espa√ßos corretos
                    cleanAddress.replace(/\s*-\s*/, ' - '), // Garantir espa√ßos no h√≠fen
                    cleanAddress.replace(/,\s*Brasil$/, ', PE, Brasil'), // Adicionar estado
                    cleanAddress.replace(/,\s*Brasil$/, ', Pernambuco, Brasil'), // Nome completo do estado
                ];
                
                // Se o endere√ßo tem cidade, tentar apenas com cidade e estado
                const addressParts = cleanAddress.split(',');
                if (addressParts.length > 2) {
                    const cityState = addressParts.slice(-2).join(',').trim();
                    searchVariations.push(cityState + ', Brasil');
                    searchVariations.push(cityState + ', PE, Brasil');
                    searchVariations.push(cityState + ', Pernambuco, Brasil');
                }
                
                console.log('üîç Varia√ß√µes de busca:', searchVariations);
                
                // Tentar cada varia√ß√£o
                for (let i = 0; i < searchVariations.length; i++) {
                    const searchQuery = searchVariations[i];
                    console.log(`üîç Tentativa ${i + 1}:`, searchQuery);
                    
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1&countrycodes=br`);
                        const data = await response.json();
                        console.log(`üì® Resposta Nominatim (tentativa ${i + 1}):`, data);
                        
                        if (data && data.length > 0) {
                            const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                            
                            // Verificar se as coordenadas est√£o no Brasil (latitude entre -34 e 6, longitude entre -74 e -34)
                            if (coords[0] >= -34 && coords[0] <= 6 && coords[1] >= -74 && coords[1] <= -34) {
                                console.log('‚úÖ Coordenadas encontradas (Brasil):', coords);
                                return coords;
                            } else {
                                console.log('‚ùå Coordenadas fora do Brasil:', coords);
                                continue;
                            }
                        }
                    } catch (error) {
                        console.log(`‚ùå Erro na tentativa ${i + 1}:`, error);
                        continue;
                    }
                }
                
                // Se n√£o encontrou, usar coordenadas de Recife como fallback
                console.log('üîÑ Usando coordenadas de Recife como fallback');
                return [-8.0476, -34.8770];
                
            } catch (error) {
                console.error('üí• Erro ao geocodificar:', error);
                // Em caso de erro, retornar coordenadas de Recife
                return [-8.0476, -34.8770];
            }
        }
        
        // Fun√ß√£o para calcular rota
        async function calculateRoute(destinoCoords) {
            try {
                // Coordenadas da empresa (Recife)
                const origem = [-8.0476, -34.8770]; // [lat, lng]
                // OSRM espera: longitude,latitude
                const url = `https://router.project-osrm.org/route/v1/driving/${origem[1]},${origem[0]};${destinoCoords[1]},${destinoCoords[0]}?overview=full&geometries=geojson`;
                console.log('URL da rota:', url);

                const response = await fetch(url);
                const data = await response.json();
                console.log('Resposta OSRM:', data);

                if (data.routes && data.routes.length > 0) {
                    const route = data.routes[0];
                    // Remover rota anterior
                    if (routeLayer) {
                        map.removeLayer(routeLayer);
                    }
                    // Adicionar nova rota
                    routeLayer = L.geoJSON(route.geometry, {
                        style: {
                            color: '#007bff',
                            weight: 4,
                            opacity: 0.7
                        }
                    }).addTo(map);
                    // Ajustar view para mostrar toda a rota
                    map.fitBounds(routeLayer.getBounds());
                    // Mostrar informa√ß√µes da rota
                    const distancia = (route.distance / 1000).toFixed(1);
                    const duracao = Math.round(route.duration / 60);
                    const routeDetails = document.getElementById('route-details');
                    const routeInfo = document.getElementById('route-info');
                    if (routeDetails && routeInfo) {
                        routeDetails.innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Dist√¢ncia:</strong> ${distancia} km
                                </div>
                                <div class="col-md-6">
                                    <strong>Tempo estimado:</strong> ${duracao} minutos
                                </div>
                            </div>
                        `;
                        routeInfo.style.display = 'block';
                        console.log('‚úÖ Informa√ß√µes da rota exibidas!');
                    } else {
                        console.log('‚ùå Elementos de rota n√£o encontrados');
                    }
                } else {
                    alert('N√£o foi poss√≠vel tra√ßar a rota entre os pontos. Verifique se o endere√ßo est√° correto e se ambos os pontos est√£o no Brasil.');
                    console.log('‚ùå Nenhuma rota encontrada pelo OSRM.');
                }
            } catch (error) {
                alert('Erro ao calcular rota: ' + error.message);
                console.error('üí• Erro ao calcular rota:', error);
            }
        }
        
        // Fun√ß√£o para calcular hor√°rio de retorno (8 horas depois)
        function calcularHorarioRetorno(horaSaida) {
            console.log('‚è∞ Calculando hor√°rio de retorno para:', horaSaida);
            if (!horaSaida) {
                console.log('‚ùå Hora de sa√≠da n√£o fornecida');
                return;
            }
            
            const [hora, minuto] = horaSaida.split(':').map(Number);
            console.log('üìä Hora:', hora, 'Minuto:', minuto);
            
            // Calcular 8 horas depois
            let novaHora = hora + 8;
            let novaMinuto = minuto;
            
            // Ajustar se passar de 24 horas
            if (novaHora >= 24) {
                novaHora = novaHora - 24;
            }
            
            const horaRetorno = novaHora.toString().padStart(2, '0');
            const minutoRetorno = novaMinuto.toString().padStart(2, '0');
            const horarioCompleto = `${horaRetorno}:${minutoRetorno}`;
            
            console.log('‚úÖ Hor√°rio de retorno calculado:', horarioCompleto);
            
            if (horaRetornoField) {
                horaRetornoField.value = horarioCompleto;
                console.log('‚úÖ Campo de retorno atualizado!');
            } else {
                console.log('‚ùå Campo de retorno n√£o encontrado');
            }
        }
        
        // Fun√ß√£o para processar endere√ßo e calcular rota
        async function processarEndereco(endereco) {
            if (!endereco.trim()) {
                console.log('‚ùå Endere√ßo vazio');
                return;
            }
            
            console.log('üîÑ Processando endere√ßo:', endereco);
            
            // Remover marcador anterior
            if (destinoMarker) {
                map.removeLayer(destinoMarker);
            }
            
            // Geocodificar endere√ßo
            const coords = await geocodeAddress(endereco);
            
            if (coords) {
                // Adicionar marcador de destino
                destinoMarker = L.marker(coords).addTo(map);
                destinoMarker.bindPopup('<strong>Destino</strong><br>' + endereco).openPopup();
                console.log('‚úÖ Marcador de destino adicionado');
                
                // Calcular rota
                await calculateRoute(coords);
                
                // Mostrar mensagem de sucesso se usou coordenadas aproximadas
                if (endereco.toLowerCase().includes('s√£o louren√ßo da mata')) {
                    console.log('‚ÑπÔ∏è Usando coordenadas aproximadas de S√£o Louren√ßo da Mata');
                }
            } else {
                console.log('‚ùå Endere√ßo n√£o encontrado:', endereco);
                alert('N√£o foi poss√≠vel encontrar o endere√ßo. Verifique se est√° correto.');
            }
        }
        
        // Event listener para mudan√ßa no CEP
        if (cepField) {
            console.log('üîó Configurando evento para CEP');
            cepField.addEventListener('blur', async function() {
                const cep = this.value.trim();
                console.log('üìù CEP digitado:', cep);
                
                if (cep) {
                    const endereco = await buscarCep(cep);
                    
                    if (endereco) {
                        if (enderecoField) {
                            enderecoField.value = endereco;
                            console.log('‚úÖ Endere√ßo preenchido automaticamente');
                        }
                        await processarEndereco(endereco);
                    } else {
                        alert('CEP n√£o encontrado. Verifique se est√° correto.');
                    }
                }
            });
            
            // M√°scara para CEP
            cepField.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                console.log('üî¢ CEP digitado (apenas n√∫meros):', value);
                
                if (value.length > 5) {
                    value = value.substring(0, 5) + '-' + value.substring(5, 8);
                }
                
                console.log('üî¢ CEP formatado:', value);
                this.value = value;
            });
        }
        
        // Event listener para mudan√ßa no campo de endere√ßo
        if (enderecoField) {
            console.log('üîó Configurando evento para endere√ßo');
            enderecoField.addEventListener('blur', async function() {
                const endereco = this.value.trim();
                console.log('üìù Endere√ßo digitado:', endereco);
                if (endereco) {
                    await processarEndereco(endereco);
                }
            });
        }
        
        // Event listener para mudan√ßa no hor√°rio de sa√≠da
        if (horaSaidaField) {
            console.log('üîó Configurando evento para hora de sa√≠da');
            horaSaidaField.addEventListener('change', function() {
                console.log('‚è∞ Hor√°rio de sa√≠da selecionado:', this.value);
                calcularHorarioRetorno(this.value);
            });
        }
        
        // Atualizar hor√°rios dispon√≠veis conforme a data escolhida
        const dataField = document.getElementById('id_data_realizacao') || document.getElementById('data_realizacao');

        if (dataField && horaSaidaField) {
            dataField.addEventListener('change', async function() {
                const data = this.value;
                if (!data) return;
                // Buscar hor√°rios livres via AJAX
                try {
                    const response = await fetch(`/solicitacoes/horarios-livres/?data=${data}`);
                    const result = await response.json();
                    const horarios = result.horarios || [];
                    // Limpar op√ß√µes atuais
                    horaSaidaField.innerHTML = '<option value="">Selecione um hor√°rio</option>';
                    // Adicionar hor√°rios livres
                    horarios.forEach(horario => {
                        const opt = document.createElement('option');
                        opt.value = horario;
                        opt.textContent = horario;
                        horaSaidaField.appendChild(opt);
                    });
                } catch (e) {
                    console.error('Erro ao buscar hor√°rios livres:', e);
                }
            });
        }
        
        console.log('‚úÖ Todos os event listeners configurados!');
        console.log('=== SISTEMA PRONTO PARA USO ===');
    });
</script>
{% endblock %}
